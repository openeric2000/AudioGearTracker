@using Microsoft.AspNetCore.Hosting
@using Microsoft.AspNetCore.Mvc.ViewEngines
<!DOCTYPE html>
<html lang="zh-tw">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - AudioGearTracker</title>
    <script src="https://unpkg.com/@@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/AudioGearTracker.styles.css" asp-append-version="true" />
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/airbnb.css">

    <style type="text/tailwindcss">
        @@theme {
            --color-lilac: #cd99d6;
            --color-lilac-hover: #b57bbf;
            --color-lilac-bg: #fbf5fc;
        }

        body {
            /* 預設字體與背景 */
            @@apply bg-gray-50 text-gray-800 font-sans antialiased;
        }

        /* Flatpickr Lilac Theme Overrides */
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected.inRange, .flatpickr-day.startRange.inRange, .flatpickr-day.endRange.inRange, .flatpickr-day.selected:focus, .flatpickr-day.startRange:focus, .flatpickr-day.endRange:focus, .flatpickr-day.selected:hover, .flatpickr-day.startRange:hover, .flatpickr-day.endRange:hover, .flatpickr-day.selected.prevMonthDay, .flatpickr-day.startRange.prevMonthDay, .flatpickr-day.endRange.prevMonthDay, .flatpickr-day.selected.nextMonthDay, .flatpickr-day.startRange.nextMonthDay, .flatpickr-day.endRange.nextMonthDay {
            background: #cd99d6 !important;
            border-color: #cd99d6 !important;
        }
    </style>
</head>

<body class="flex flex-col min-h-screen bg-gray-50">
    <header class="sticky top-0 z-50 backdrop-blur-md bg-white/80 border-b border-gray-200 shadow-sm">
        <nav class="container mx-auto px-4 md:px-6 h-16 flex items-center justify-between gap-4 md:gap-8">

            <a asp-controller="Home" asp-action="Index"
                class="flex-shrink-0 text-xl md:text-2xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-lilac to-purple-600 hover:opacity-80 transition-opacity">
                AudioGear<span class="text-gray-700">Tracker</span>
            </a>

            <div class="relative flex-grow max-w-lg hidden md:block">
                <div class="relative">
                    <input type="text" id="global-search" placeholder="搜尋器材 (例如: Sony, DAC...)"
                        class="w-full pl-10 pr-4 py-2 bg-gray-100 border-transparent text-gray-700 rounded-full focus:bg-white focus:border-lilac focus:ring-2 focus:ring-lilac/50 transition-all placeholder-gray-400 outline-none"
                        autocomplete="off" />

                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>

                <div id="search-results"
                    class="absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-xl border border-gray-100 overflow-hidden hidden" style="z-index: 60;">
                </div>
            </div>

            <div class="hidden md:flex items-center space-x-6 flex-shrink-0">
                <a asp-controller="Brands" asp-action="Index"
                    class="text-sm font-medium text-gray-600 hover:text-lilac transition-colors">品牌管理</a>
                <a asp-controller="Equipments" asp-action="Index"
                    class="px-5 py-2 text-sm font-bold text-white bg-lilac rounded-full shadow-lg shadow-lilac/30 hover:bg-lilac-hover hover:-translate-y-0.5 transition-all duration-300">
                    器材清單
                </a>
            </div>

            <!-- Mobile Menu Button -->
            <button id="mobile-menu-btn" class="md:hidden text-gray-600 hover:text-lilac focus:outline-none p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path class="menu-icon" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                    <path class="close-icon hidden" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </nav>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white/95 backdrop-blur-xl border-t border-gray-100 absolute w-full left-0 shadow-lg top-16 px-4 py-6 space-y-6 flex flex-col items-center animate-fade-in-down transition-all duration-300">
            <!-- Mobile Search -->
            <div class="relative w-full">
                <input type="text" id="mobile-search" placeholder="搜尋器材..." class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 text-gray-800 rounded-xl focus:bg-white focus:border-lilac focus:ring-2 focus:ring-lilac/50 transition-all outline-none" />
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <div id="mobile-search-results" class="absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-xl border border-gray-100 overflow-hidden hidden" style="z-index: 60;"></div>
            </div>

            <div class="flex flex-col space-y-4 w-full text-center">
                <a asp-controller="Brands" asp-action="Index" class="text-lg font-bold text-gray-700 hover:text-lilac block py-2 border-b border-gray-50 w-full">品牌管理</a>
                <a asp-controller="Equipments" asp-action="Index" class="px-5 py-3 text-lg font-bold text-white bg-lilac rounded-xl shadow-md block w-full">器材清單</a>
            </div>
        </div>
    </header>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Mobile Menu Toggle
            const btn = document.getElementById('mobile-menu-btn');
            const menu = document.getElementById('mobile-menu');
            const menuIcon = btn.querySelector('.menu-icon');
            const closeIcon = btn.querySelector('.close-icon');

            if(btn && menu) {
                btn.addEventListener('click', () => {
                    menu.classList.toggle('hidden');
                    menuIcon.classList.toggle('hidden');
                    closeIcon.classList.toggle('hidden');
                });
            }

            // Search Functionality
            function setupSearch(inputId, resultsId) {
                const searchInput = document.getElementById(inputId);
                const resultsBox = document.getElementById(resultsId);
                let debounceTimer;

                if (!searchInput || !resultsBox) return;

                // 監聽打字事件
                searchInput.addEventListener('input', function (e) {
                    const term = e.target.value.trim();

                    // 清除之前的計時器 (Debounce: 避免每打一個字就發請求)
                    clearTimeout(debounceTimer);

                    if (term.length < 1) {
                        resultsBox.classList.add('hidden');
                        resultsBox.innerHTML = '';
                        return;
                    }

                    // 延遲 300ms 後才發送請求
                    debounceTimer = setTimeout(() => {
                        fetch(`/Equipments/SearchJson?term=${encodeURIComponent(term)}`)
                            .then(response => response.json())
                            .then(data => {
                                resultsBox.innerHTML = ''; // 清空舊結果

                                if (data.length > 0) {
                                    resultsBox.classList.remove('hidden');
                                    data.forEach(item => {
                                        // 建立選項 HTML
                                        const a = document.createElement('a');
                                        a.href = item.url;
                                        a.className = 'block px-4 py-3 hover:bg-gray-50 transition-colors border-b border-gray-50 last:border-0 flex justify-between items-center';
                                        a.innerHTML = `
                                            <div>
                                                <div class="font-bold text-gray-800">${item.title}</div>
                                                <div class="text-xs text-gray-500">${item.subtitle}</div>
                                            </div>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                            </svg>
                                        `;
                                        resultsBox.appendChild(a);
                                    });
                                } else {
                                    // 查無資料
                                    resultsBox.classList.remove('hidden');
                                    resultsBox.innerHTML = `<div class="px-4 py-3 text-sm text-gray-400 text-center">找不到 "${term}" 相關的器材</div>`;
                                }
                            });
                    }, 300);
                });

                // 點擊外部時關閉選單
                document.addEventListener('click', function (e) {
                    if (!searchInput.contains(e.target) && !resultsBox.contains(e.target)) {
                        resultsBox.classList.add('hidden');
                    }
                });

                // 聚焦時如果有字就重新顯示
                searchInput.addEventListener('focus', function () {
                    if (searchInput.value.trim().length > 0 && resultsBox.children.length > 0) {
                        resultsBox.classList.remove('hidden');
                    }
                });
            }

            setupSearch('global-search', 'search-results');
            setupSearch('mobile-search', 'mobile-search-results');
        });
    </script>

    <main role="main" class="flex-grow container mx-auto px-6 py-8">
        @RenderBody()
    </main>

    <footer class="border-t border-gray-200 bg-white py-6 mt-auto">
        <div class="container mx-auto px-6 text-center text-sm text-gray-500">
            &copy; 2026 - AudioGearTracker - <span class="text-lilac font-semibold">Designed for Audiophiles</span>
        </div>
    </footer>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>

    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/zh-tw.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            flatpickr(".datepicker", {
                "locale": "zh_tw",
                dateFormat: "Y-m-d",
                allowInput: true,
                altInput: true,
                altFormat: "Y/m/d",
                disableMobile: "true" // Force flatpickr on mobile too for consistency
            });
        });
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>

</html>